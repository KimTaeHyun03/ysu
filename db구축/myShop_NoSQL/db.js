/**
 * ====================================================================
 * 데이터베이스 연결 및 관리 모듈 (db.js)
 * ====================================================================
 * 
 * 역할: MongoDB 데이터베이스와의 연결을 관리하고 다른 모듈에서 사용할 수 있는
 *      데이터베이스 인스턴스를 제공하는 중앙 집중식 DB 관리 모듈
 * 
 * 주요 기능:
 * - MongoDB 연결 풀(Connection Pool) 생성 및 관리
 * - 데이터베이스 연결 상태 모니터링
 * - 다른 모듈에서 사용할 db 인스턴스 export
 * - 연결 풀을 통한 성능 최적화
 * 
 * 사용하는 모듈:
 * - Main.js: 상품 조회, 장바구니 추가 API
 * - auth.js: 회원가입, 로그인 처리
 * - cartView.js: 장바구니 관련 모든 DB 작업
 * ====================================================================
 */

// MongoDB Node.js 드라이버 import
// mongodb를 사용하여 async/await 패턴으로 DB 작업 가능
var { MongoClient } = require('mongodb');

/**
 * MongoDB 연결 풀(Connection Pool) 생성
 * ====================================================================
 * 연결 풀을 사용하는 이유:
 * 1. 성능 향상: 매번 새 연결을 생성하지 않고 기존 연결 재사용
 * 2. 리소스 관리: 동시 연결 수 제한으로 서버 부하 방지
 * 3. 안정성: 연결 실패 시 자동 재연결 및 에러 핸들링
 * ====================================================================
 */

// 환경변수 관련 패키지 임포트
require('dotenv').config();

// MongoDB(DocumentDB) 버전
var client = new MongoClient(process.env.MONGODB_URI, {
  maxPoolSize: 10,                // 연결 풀 크기
  serverSelectionTimeoutMS: 5000, // 서버 선택 타임아웃
  socketTimeoutMS: 45000,         // 소켓 타임아웃
});

// 데이터베이스 지정
var db = client.db(process.env.MONGODB_DATABASE);

/**
 * 데이터베이스 연결 테스트 및 초기화
 * ====================================================================
 * 서버 시작 시 데이터베이스 연결 상태를 확인하여
 * 문제가 있을 경우 즉시 파악할 수 있도록 함
 * ====================================================================
 */
client.connect()
    .then(() => {
        console.log('데이터베이스에 성공적으로 연결되었습니다.');
    })
    .catch(err => {
        console.error('데이터베이스 연결 오류:', err);
    }); 

/**
 * 모듈 내보내기
 * ====================================================================
 * 다른 모듈에서 require('./db.js')로 이 db 인스턴스를 사용할 수 있음
 * 
 * 사용 예시:
 * const db = require('./db.js');
 * const results = await db.collection('products').find({}).toArray();
 * ====================================================================
 */
module.exports = db;